<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DBD Score Overlay</title>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="overlay">
    <div class="header">Realm of the Pink Ribbon Tourney</div>

    <div class="middle-row">
      <div class="middle-item" id="roundLabel">Round 1</div>
      <div class="middle-item" id="teamAName">Team 1</div>
      <div class="middle-item score" id="scoreA">0</div>
      <div class="middle-item" id="teamBName">Team 2</div>
      <div class="middle-item score" id="scoreB">0</div>
    </div>

    <div class="bottom-row" id="matchLabel">Match 1</div>
  </div>

<script src="config.js"></script>
<script>
// DOM Elements
const teamANameEl = document.getElementById('teamAName');
const teamBNameEl = document.getElementById('teamBName');
const scoreAEl = document.getElementById('scoreA');
const scoreBEl = document.getElementById('scoreB');
const matchEl = document.getElementById('matchLabel');
const roundEl = document.getElementById('roundLabel');

let lastData = null;

// Parse Google Sheets JSON feed
function parseSheetJSON(text) {
  // Remove the leading Google callback text
  const jsonText = text.replace(/.*?({.*});?$/, "$1");
  return JSON.parse(jsonText);
}

// Fetch + Update
async function fetchAndUpdateJSON() {
  try {
    const url = SHEET_CSV_URL.replace("output=csv","gviz/tq?tqx=out:json&sheet=Active%20Game%20Tracker");
    const res = await fetch(url, {cache:"no-store"});
    if (!res.ok) throw new Error("Fetch failed: " + res.status);
    const text = await res.text();
    const data = parseSheetJSON(text);
    
    const rows = data.table.rows;

    // Extract values from your sheet layout
    const getC = (rowIndex) => {
      if(rows[rowIndex] && rows[rowIndex].c[2]) return rows[rowIndex].c[2].v;
      return "";
    }

    const matchNum = getC(1);   // Row 2
    const roundNum = getC(2);   // Row 3
    const teamANum = getC(3);   // Row 4
    const teamAPts = getC(4);   // Row 5
    const teamBNum = getC(5);   // Row 6
    const teamBPts = getC(6);   // Row 7

    const parsedData = {matchNum, roundNum, teamANum, teamAPts, teamBNum, teamBPts};

    if(JSON.stringify(parsedData) !== JSON.stringify(lastData)){
      lastData = parsedData;
      roundEl.textContent = roundNum ? "Round " + roundNum : "Round";
      teamANameEl.textContent = teamANum ? "Team " + teamANum : "Team A";
      teamBNameEl.textContent = teamBNum ? "Team " + teamBNum : "Team B";
      scoreAEl.textContent = teamAPts || "0";
      scoreBEl.textContent = teamBPts || "0";
      matchEl.textContent = matchNum ? "Match " + matchNum : "Match";
    }
  } catch(err) {
    console.error("Error fetching/parsing JSON feed:", err);
  }
}

fetchAndUpdateJSON();
setInterval(fetchAndUpdateJSON, FETCH_INTERVAL_MS);
</script>
</body>
</html>
