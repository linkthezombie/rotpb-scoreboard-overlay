<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DBD Score Overlay</title>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="overlay">
    <div class="header">Realm of the Pink Ribbon Tourney</div>

    <div class="middle-row">
      <div class="middle-item" id="roundLabel">Round 1</div>
      <div class="middle-item" id="teamAName">Team 1</div>
      <div class="middle-item score" id="scoreA">0</div>
      <div class="middle-item" id="teamBName">Team 2</div>
      <div class="middle-item score" id="scoreB">0</div>
    </div>

    <div class="bottom-row" id="matchLabel">Match 1</div>
  </div>

<script src="config.js"></script>
<script>
// CSV parser
function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(l => l.trim().length>0);
  return lines.map(line => line.split(',').map(c => c.replace(/^"|"$/g,'').trim()));
}

// DOM Elements
const teamANameEl = document.getElementById('teamAName');
const teamBNameEl = document.getElementById('teamBName');
const scoreAEl = document.getElementById('scoreA');
const scoreBEl = document.getElementById('scoreB');
const matchEl = document.getElementById('matchLabel');
const roundEl = document.getElementById('roundLabel');

let lastData = null;

async function fetchAndUpdate() {
  try {
    const res = await fetch(SHEET_CSV_URL, {cache:"no-store"});
    if (!res.ok) throw new Error("Fetch failed: " + res.status);
    const text = await res.text();
    const rows = parseCSV(text);

    const c = i => (rows[i] && rows[i][2] !== undefined) ? rows[i][2] : "";

    const matchNum = c(START_ROW_INDEX) || "";
    const roundNum = c(START_ROW_INDEX + 1) || "";
    const teamANum = c(START_ROW_INDEX + 2) || "";
    const teamAPts = c(START_ROW_INDEX + 3) || "";
    const teamBNum = c(START_ROW_INDEX + 4) || "";
    const teamBPts = c(START_ROW_INDEX + 5) || "";

    const data = {matchNum, roundNum, teamANum, teamAPts, teamBNum, teamBPts};

    if(JSON.stringify(data) !== JSON.stringify(lastData)){
      lastData = data;

      roundEl.textContent = roundNum ? "Round " + roundNum : "Round";
      teamANameEl.textContent = teamANum ? "Team " + teamANum : "Team A";
      teamBNameEl.textContent = teamBNum ? "Team " + teamBNum : "Team B";
      scoreAEl.textContent = teamAPts || "0";
      scoreBEl.textContent = teamBPts || "0";
      matchEl.textContent = matchNum ? "Match " + matchNum : "Match";
    }
  } catch(err){
    console.error("Error fetching/parsing CSV:", err);
  }
}

fetchAndUpdate();
setInterval(fetchAndUpdate, FETCH_INTERVAL_MS);
</script>
</body>
</html>
