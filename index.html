<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DBD Score Overlay</title>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="overlay">
    <div class="header">Realm of the Pink Ribbon Tourney</div>

    <div class="middle-row">
      <div class="middle-item" id="roundLabel">Round 1</div>
      <div class="middle-item" id="teamAName">Team 1</div>
      <div class="middle-item score" id="scoreA">0</div>
      <div class="middle-item" id="teamBName">Team 2</div>
      <div class="middle-item score" id="scoreB">0</div>
    </div>

    <div class="bottom-row" id="matchLabel">Match 1</div>
  </div>

<script src="config.js"></script>
<script>
// DOM Elements
const teamANameEl = document.getElementById('teamAName');
const teamBNameEl = document.getElementById('teamBName');
const scoreAEl = document.getElementById('scoreA');
const scoreBEl = document.getElementById('scoreB');
const matchEl = document.getElementById('matchLabel');
const roundEl = document.getElementById('roundLabel');

// History of seen numeric values
let seenValues = new Set();

// Track last applied values
let lastApplied = {matchNum:null, roundNum:null, teamANum:null, teamAPts:null, teamBNum:null, teamBPts:null};

// Parse Google Sheets JSON feed
function parseSheetJSON(text) {
    const jsonText = text.replace(/.*?({.*});?$/, "$1");
    return JSON.parse(jsonText);
}

// Fetch and update with debounce / history filter
async function fetchAndUpdateJSON() {
    try {
        const url = SHEET_CSV_URL.replace("output=csv","gviz/tq?tqx=out:json&sheet=Active%20Game%20Tracker");
        const res = await fetch(url, {cache:"no-store"});
        if(!res.ok) throw new Error("Fetch failed: " + res.status);
        const text = await res.text();
        const data = parseSheetJSON(text);
        const rows = data.table.rows;

        const getC = (rowIndex) => (rows[rowIndex] && rows[rowIndex].c[2] ? rows[rowIndex].c[2].v : "");

        const matchNum = getC(1);
        const roundNum = getC(2);
        const teamANum = getC(3);
        const teamAPts = getC(4);
        const teamBNum = getC(5);
        const teamBPts = getC(6);

        const currentValues = {matchNum, roundNum, teamANum, teamAPts, teamBNum, teamBPts};

        // Create a simple string key of values
        const key = Object.values(currentValues).join('|');

        // If we have never seen this combination, apply it
        if(!seenValues.has(key)){
            seenValues.add(key);
            lastApplied = currentValues;

            roundEl.textContent = roundNum ? "Round " + roundNum : "Round";
            teamANameEl.textContent = teamANum ? "Team " + teamANum : "Team A";
            teamBNameEl.textContent = teamBNum ? "Team " + teamBNum : "Team B";
            scoreAEl.textContent = teamAPts || "0";
            scoreBEl.textContent = teamBPts || "0";
            matchEl.textContent = matchNum ? "Match " + matchNum : "Match";

            // Optional: limit the size of seenValues to prevent memory bloat
            if(seenValues.size > 50) seenValues.clear();
        }

    } catch(err){
        console.error
</script>
</body>
</html>

